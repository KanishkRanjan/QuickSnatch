{% extends "base.html" %}

{% block content %}
<div class="challenge-container">
    <h2>Level {{ level|default(1) }}: {% block level_title %}{% endblock %}</h2>
    <div class="progress mb-3">
        <div class="progress-bar" role="progressbar" 
             style="width: {{ (level|default(1) * 10) }}%" 
             aria-valuenow="{{ (level|default(1) * 10) }}" 
             aria-valuemin="0" 
             aria-valuemax="100">{{ level|default(1) }}/10</div>
    </div>

    {% block challenge_description %}{% endblock %}

    {% include 'challenges/terminal.html' %}

    <div class="flag-submission mt-4">
        <h5><i class="fas fa-flag me-2"></i>Submit Flag</h5>
        <div class="input-group">
            <input type="text" id="flag-input" class="form-control" placeholder="Enter flag...">
            <button class="btn btn-primary" onclick="submitFlag(event)">Submit</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    window.currentLevel = {{ level|default(1) }};
});

async function submitFlag(event) {
    event.preventDefault();
    const flagInput = document.getElementById('flag-input');
    const flag = flagInput.value.trim();
    
    if (!flag) {
        alert('Please enter a flag');
        return;
    }

    try {
        const response = await fetch(`/check_flag/${window.currentLevel}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ flag: flag })
        });

        const data = await response.json();
        
        if (data.success) {
            window.location.href = data.redirect;
        } else {
            alert(data.message || 'Incorrect flag. Try again!');
            flagInput.value = '';
            flagInput.focus();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error submitting flag. Please try again.');
    }
}

{% block level_scripts %}{% endblock %}
</script>
{% endblock %}
