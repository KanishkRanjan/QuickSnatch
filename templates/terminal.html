<!-- Interactive Terminal Component -->
{% block terminal %}
<div class="terminal-wrapper">
    <!-- Terminal Window -->
    <div id="terminal">
        <div class="terminal-header">
            <div class="terminal-title">QuickSnatch Terminal - Level {{ level }}</div>
            <div class="terminal-controls">
                <span class="control minimize">−</span>
                <span class="control maximize">□</span>
                <span class="control close">×</span>
            </div>
        </div>
        <div class="terminal-content">
            <div class="terminal-output"></div>
            <div class="terminal-input-line">
                <span class="prompt"></span>
                <input type="text" id="terminal-input" autocomplete="off" spellcheck="false" autofocus>
            </div>
            <div class="suggestions" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- Terminal Styles -->
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/terminal.css') }}">

<!-- Terminal Scripts -->
<script>
class Terminal {
    constructor() {
        this.level = {{ level }};
        this.username = 'player';
        this.hostname = 'quicksnatch';
        this.history = [];
        this.historyIndex = -1;
        this.commandBuffer = '';
        this.currentDirectory = '~';
        this.fileSystem = this.initializeFileSystem();
        this.processes = this.initializeProcesses();
        this.networkConnections = this.initializeNetwork();
        this.environment = this.initializeEnvironment();
        this.services = this.initializeServices();
        this.aliases = {
            ll: 'ls -l',
            la: 'ls -a',
            lla: 'ls -la',
            l: 'ls',
            c: 'clear'
        };
        
        // Command suggestions
        this.suggestions = [];
        this.selectedSuggestionIndex = -1;
    }

    init() {
        this.terminal = document.getElementById('terminal');
        this.output = document.querySelector('.terminal-output');
        this.input = document.getElementById('terminal-input');
        this.prompt = document.querySelector('.prompt');
        this.suggestionsDiv = document.querySelector('.suggestions');

        this.updatePrompt();
        this.setupEventListeners();
        this.welcomeMessage();
    }

    setupEventListeners() {
        this.input.addEventListener('keydown', (e) => this.handleKeyDown(e));
        this.input.addEventListener('input', () => this.handleInput());
        
        // Terminal controls
        document.querySelector('.close').addEventListener('click', () => this.handleClose());
        document.querySelector('.minimize').addEventListener('click', () => this.handleMinimize());
        document.querySelector('.maximize').addEventListener('click', () => this.handleMaximize());
    }

    handleKeyDown(e) {
        switch(e.key) {
            case 'Enter':
                e.preventDefault();
                const commandText = this.input.value.trim();
                if (commandText) {
                    this.executeCommand();
                }
                break;
            case 'ArrowUp':
                e.preventDefault();
                this.navigateHistory(-1);
                break;
            case 'ArrowDown':
                e.preventDefault();
                this.navigateHistory(1);
                break;
            case 'Tab':
                e.preventDefault();
                this.handleTabCompletion();
                break;
            case 'c':
                if (e.ctrlKey) {
                    e.preventDefault();
                    this.handleCtrlC();
                }
                break;
            case 'l':
                if (e.ctrlKey) {
                    e.preventDefault();
                    this.clear();
                }
                break;
        }
    }

    handleInput() {
        const input = this.input.value.trim();
        this.showSuggestions(input);
    }

    showSuggestions(input) {
        if (!input) {
            this.suggestionsDiv.style.display = 'none';
            return;
        }

        const commands = [
            'ls', 'cd', 'pwd', 'echo', 'cat', 'help', 'clear',
            'ps', 'netstat', 'env', 'whoami', 'date', 'history',
            ...Object.keys(this.aliases)
        ];

        this.suggestions = commands.filter(cmd => cmd.startsWith(input));
        
        if (this.suggestions.length > 0) {
            this.suggestionsDiv.innerHTML = this.suggestions
                .map((s, i) => `<div class="suggestion-item${i === this.selectedSuggestionIndex ? ' selected' : ''}">${s}</div>`)
                .join('');
            this.suggestionsDiv.style.display = 'block';
        } else {
            this.suggestionsDiv.style.display = 'none';
        }
    }

    handleTabCompletion() {
        if (this.suggestions.length === 1) {
            this.input.value = this.suggestions[0];
            this.suggestionsDiv.style.display = 'none';
        }
    }

    updatePrompt() {
        this.prompt.textContent = `${this.username}@${this.hostname}:${this.currentDirectory}$ `;
    }

    executeCommand() {
        const commandText = this.input.value.trim();
        if (!commandText) return;

        // Echo the command
        this.writeOutput(`${this.getPrompt()}${commandText}`);
        this.input.value = '';

        // Process the command
        const output = this.processCommand(commandText);
        if (output) {
            this.writeOutput(output);
        }

        // Add to history
        this.addToHistory(commandText);
    }

    processCommand(command) {
        const [cmd, ...args] = command.trim().split(/\s+/);
        
        switch(cmd.toLowerCase()) {
            case 'clear':
                this.clear();
                return '';
            case 'help':
                return this.getHelpText();
            case 'ls':
                return this.listDirectory(args);
            case 'pwd':
                return this.currentDirectory.replace(/^~/, '/home/player');
            case 'cd':
                const cdResult = this.changeDirectory(args[0]);
                return cdResult || ''; // Return empty string if successful
            case 'cat':
                return this.catFile(args[0]);
            case 'chmod':
                return this.chmod(args[0], args[1]);
            case 'grep':
                if (!args.length) {
                    return 'grep: missing pattern';
                }
                return this.grep(args);
            case 'ps':
                if (this.level !== 4) {
                    return 'Command ps is only available in level 4';
                }
                return `USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.0   2460   736 ?        Ss   21:13   0:00 init [1]
root         365  0.0  0.0   2780   864 ?        S    21:13   0:00 logger -t init
root         366  0.0  0.0   2780   864 ?        S    21:13   0:00 logger -t system
root       31337  0.2  0.1  14876  1232 ?        Ss   21:13   0:02 /usr/bin/suspicious_service --secret=flag{process_hunter} --stealth
user        9999  0.0  0.0   2924   896 pts/0    R+   21:14   0:00 ps aux`;
            case 'netstat':
                if (this.level !== 5) {
                    return 'Command netstat is only available in level 5';
                }
                return `Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:31337         0.0.0.0:*               LISTEN      1337/hidden_service
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -
udp        0      0 0.0.0.0:68              0.0.0.0:*                           -`;
            case 'nc':
                if (this.level !== 5) {
                    return 'Command nc is only available in level 5';
                }
                if (command === 'nc localhost 31337' || command === 'nc 127.0.0.1 31337') {
                    return 'Welcome to the hidden service!\nHere is your flag: flag{network_ninja}';
                }
                return 'Connection refused';
            case 'hint':
                return this.getHint();
            default:
                return `Command not found: ${cmd}. Type 'help' for available commands.`;
        }
    }

    writeOutput(text, className = '') {
        const line = document.createElement('div');
        line.textContent = text;
        if (className) line.className = className;
        this.output.appendChild(line);
        this.terminal.querySelector('.terminal-content').scrollTop = this.terminal.querySelector('.terminal-content').scrollHeight;
    }

    clear() {
        this.output.innerHTML = '';
    }

    addToHistory(command) {
        this.history.push(command);
        if (this.history.length > 100) {
            this.history.shift();
        }
        this.historyIndex = this.history.length;
    }

    navigateHistory(direction) {
        const newIndex = this.historyIndex + direction;
        if (newIndex >= 0 && newIndex <= this.history.length) {
            this.historyIndex = newIndex;
            this.input.value = this.historyIndex === this.history.length ? this.commandBuffer : this.history[this.historyIndex];
        }
    }

    handleCtrlC() {
        this.writeOutput(`^C`);
        this.input.value = '';
        this.updatePrompt();
    }

    handleClose() {
        // Implement close behavior
        this.writeOutput('Terminal cannot be closed in challenge mode', 'error');
    }

    handleMinimize() {
        this.terminal.style.opacity = '0.8';
    }

    handleMaximize() {
        this.terminal.style.opacity = '1';
        // Toggle fullscreen logic here
    }

    welcomeMessage() {
        const message = this.getLevelWelcomeMessage();
        this.writeOutput(message);
    }

    getLevelWelcomeMessage() {
        switch (this.level) {
            case 1:
                return `Welcome to Level 1: File Explorer Challenge
Your task is to navigate the file system and find hidden files.
Use 'ls', 'cd', and 'cat' commands to explore and read files.
Type 'help' for available commands or 'hint' if you need help.`;
            case 2:
                return `Welcome to Level 2: Permission Challenge
Your task is to manage file permissions to access protected files.
Use the 'chmod' command to modify file permissions.
Type 'help' for available commands or 'hint' if you need help.`;
            case 3:
                return `Welcome to Level 3: Pattern Search Challenge
Your task is to search through log files to find hidden patterns.
Use the 'grep' command to search for text patterns.
Type 'help' for available commands or 'hint' if you need help.`;
            case 4:
                return `Welcome to Level 4: Process Investigation Challenge
Your task is to identify and investigate suspicious processes running on the system.
Use the 'ps' command to list processes and examine /proc filesystem for details.
Look for any unusual or suspicious processes that might contain sensitive information.
Type 'help' for available commands or 'hint' if you need help.`;
            case 5:
                return `Welcome to Level 5: Network Ninja Challenge
Your task is to analyze network connections and find hidden services.
Use 'netstat' to view connections and 'nc' to interact with services.
Type 'help' for available commands or 'hint' if you need help.`;
            default:
                return `Welcome to QuickSnatch Terminal
Type 'help' for available commands or 'hint' if you need help.`;
        }
    }

    getHelpText() {
        const commonCommands = `
Common Commands:
  help     - Show this help message
  clear    - Clear terminal screen
  submit   - Submit a flag (format: flag{...})
  hint     - Show a hint for current level`;

        let levelSpecificCommands = '';
        switch (this.level) {
            case 1:
                levelSpecificCommands = `
Level 1 Commands:
  ls       - List directory contents
  cd       - Change directory
  pwd      - Print working directory
  cat      - Display file contents`;
                break;
            case 2:
                levelSpecificCommands = `
Level 2 Commands:
  ls       - List directory contents
  cd       - Change directory
  pwd      - Print working directory
  cat      - Display file contents
  chmod    - Change file permissions`;
                break;
            case 3:
                levelSpecificCommands = `
Level 3 Commands:
  ls       - List directory contents
  cd       - Change directory
  pwd      - Print working directory
  cat      - Display file contents
  grep     - Search text patterns in files`;
                break;
            case 4:
                levelSpecificCommands = `
Level 4 Commands:
  ls       - List directory contents
  cd       - Change directory
  pwd      - Print working directory
  cat      - Display file contents
  ps       - List running processes`;
                break;
            case 5:
                levelSpecificCommands = `
Level 5 Commands:
  ls       - List directory contents
  cd       - Change directory
  pwd      - Print working directory
  cat      - Display file contents
  netstat  - Display network connections
  nc       - Connect to network services`;
                break;
        }

        return commonCommands + levelSpecificCommands;
    }

    initializeEnvironment() {
        return {
            'HOME': '/home/player',
            'USER': 'player',
            'SHELL': '/bin/bash',
            'PWD': '/home/player',
            'LANG': 'en_US.UTF-8',
            'TERM': 'xterm-256color',
            'PATH': '/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin',
            'EDITOR': 'vim',
            'HISTSIZE': '1000',
            'HISTFILESIZE': '2000',
            'PS1': '\\u@\\h:\\w\\$ ',
            'LEVEL': this.level.toString()
        };
    }

    initializeProcesses() {
        const baseProcesses = [
            { pid: 1, user: 'root', command: '/sbin/init' },
            { pid: 2, user: 'root', command: '[kthreadd]' },
            { pid: 854, user: 'root', command: '/usr/sbin/sshd -D' },
            { pid: 1024, user: 'mysql', command: 'mysqld' },
            { pid: 1337, user: 'player', command: 'bash' }
        ];

        if (this.level >= 4) {
            baseProcesses.push(
                { pid: 1234, user: 'player', command: '/usr/bin/suspicious_process --flag=flag{process_hunter_success}' }
            );
        }

        return baseProcesses;
    }

    initializeNetwork() {
        const baseConnections = [
            { proto: 'tcp', local: '0.0.0.0:22', foreign: '0.0.0.0:*', state: 'LISTEN' },
            { proto: 'tcp6', local: ':::80', foreign: ':::*', state: 'LISTEN' }
        ];

        if (this.level >= 5) {
            baseConnections.push(
                { proto: 'tcp', local: '127.0.0.1:12345', foreign: '0.0.0.0:*', state: 'LISTEN' }
            );
        }

        return baseConnections;
    }

    initializeServices() {
        const baseServices = [
            { name: 'ssh', status: 'running', port: 22 },
            { name: 'nginx', status: 'running', port: 80 }
        ];

        return baseServices;
    }

    initializeFileSystem() {
        const fs = {
            '/': {
                type: 'dir',
                permissions: 'drwxr-xr-x',
                owner: 'root',
                group: 'root',
                contents: {
                    'bin': {
                        type: 'dir',
                        permissions: 'drwxr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: {
                            'bash': { type: 'file', permissions: '-rwxr-xr-x', owner: 'root', group: 'root', content: 'ELF...' },
                            'ls': { type: 'file', permissions: '-rwxr-xr-x', owner: 'root', group: 'root', content: 'ELF...' }
                        }
                    },
                    'etc': {
                        type: 'dir',
                        permissions: 'drwxr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: {
                            'passwd': {
                                type: 'file',
                                permissions: '-rw-r--r--',
                                owner: 'root',
                                group: 'root',
                                content: 'root:x:0:0:root:/root:/bin/bash\nplayer:x:1000:1000:Player,,,:/home/player:/bin/bash'
                            },
                            'shadow': {
                                type: 'file',
                                permissions: '-rw-r-----',
                                owner: 'root',
                                group: 'shadow',
                                content: 'root:$6$xyz...\nplayer:$6$abc...'
                            },
                            'hostname': {
                                type: 'file',
                                permissions: '-rw-r--r--',
                                owner: 'root',
                                group: 'root',
                                content: 'quicksnatch'
                            }
                        }
                    },
                    'home': {
                        type: 'dir',
                        permissions: 'drwxr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: {
                            'player': this.initializeHomeDirectory()
                        }
                    },
                    'proc': {
                        type: 'dir',
                        permissions: 'dr-xr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: this.initializeProcDirectory()
                    },
                    'var': {
                        type: 'dir',
                        permissions: 'drwxr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: {
                            'log': {
                                type: 'dir',
                                permissions: 'drwxr-xr-x',
                                owner: 'root',
                                group: 'root',
                                contents: {
                                    'auth.log': {
                                        type: 'file',
                                        permissions: '-rw-r--r--',
                                        owner: 'root',
                                        group: 'root',
                                        content: 'Jan 18 10:42:01 quicksnatch sshd[854]: Server listening on 0.0.0.0 port 22.'
                                    }
                                }
                            }
                        }
                    }
                }
            }
        };

        // Add level-specific files
        this.addLevelSpecificFiles(fs);
        return fs;
    }

    addLevelSpecificFiles(fs) {
        const playerHome = fs['/'].contents['home'].contents['player'];
        
        switch(this.level) {
            case 1:
                // Level 1: Hidden Files Challenge
                playerHome.contents['.secret'] = {
                    type: 'file',
                    permissions: '-rw-r--r--',
                    owner: 'player',
                    group: 'player',
                    content: 'Congratulations! You found the hidden file.\nflag{hidden_file_master}'
                };
                break;

            case 2:
                // Level 2: Permissions Challenge
                playerHome.contents['restricted.txt'] = {
                    type: 'file',
                    permissions: '-r--------',
                    owner: 'root',
                    group: 'root',
                    content: 'Well done! You\'ve mastered file permissions.\nflag{chmod_master}'
                };
                break;

            case 3:
                // Level 3: Log Analysis Challenge
                playerHome.contents['system.log'] = {
                    type: 'file',
                    permissions: '-rw-r--r--',
                    owner: 'player',
                    group: 'player',
                    content: `
[2024-01-18 10:00:01] System startup initialized
[2024-01-18 10:00:02] User authentication: admin logged in from 192.168.1.100
[2024-01-18 10:00:03] Security alert: Unauthorized access attempt from 10.0.0.5
[2024-01-18 10:00:04] Service started: nginx on port 80
[2024-01-18 10:00:05] Database connection established to mysql://localhost:3306
[2024-01-18 10:00:06] Critical: flag{grep_master_123}
[2024-01-18 10:00:07] Backup process completed successfully
[2024-01-18 10:00:08] System health check: All services running normally
                    `.trim()
                };
                break;

            case 4:
                // Level 4: Process Investigation Challenge
                playerHome.contents['.bash_history'] = {
                    type: 'file',
                    permissions: '-rw-r--r--',
                    owner: 'player',
                    group: 'player',
                    content: `
ls
cd /home/player
ps aux
netstat -tulpn
ls -la /proc
cat /proc/1234/cmdline
ps -ef | grep suspicious
                    `.trim()
                };
                
                // Add suspicious process information in /proc
                const procDir = fs['/'].contents['proc'].contents;
                procDir['31337'] = {
                    type: 'dir',
                    permissions: 'dr-xr-xr-x',
                    owner: 'root',
                    group: 'root',
                    contents: {
                        'cmdline': {
                            type: 'file',
                            permissions: '-r--r--r--',
                            owner: 'root',
                            group: 'root',
                            content: '/usr/bin/suspicious_service --secret=flag{process_hunter} --stealth'
                        },
                        'status': {
                            type: 'file',
                            permissions: '-r--r--r--',
                            owner: 'root',
                            group: 'root',
                            content: `
Name:   suspicious_service
State:  S (sleeping)
Tgid:   31337
Pid:    31337
PPid:   1
TracerPid:  0
Uid:    0   0   0   0
Gid:    0   0   0   0
FDSize: 256
Groups: 0
VmPeak:    14876 kB
VmSize:    14876 kB
VmLck:         0 kB
VmPin:         0 kB
VmHWM:      1232 kB
VmRSS:      1232 kB
                            `.trim()
                        }
                    }
                };
                break;

            case 5:
                // Level 5: Network Challenge
                this.networkConnections.push({
                    proto: 'tcp',
                    local: '127.0.0.1:31337',
                    foreign: '*:*',
                    state: 'LISTEN',
                    info: 'Hidden service running with flag{network_ninja}'
                });
                break;
        }
    }

    initializeHomeDirectory() {
        return {
            type: 'dir',
            permissions: 'drwxr-xr-x',
            owner: 'player',
            group: 'player',
            contents: {
                'Documents': {
                    type: 'dir',
                    permissions: 'drwxr-xr-x',
                    owner: 'player',
                    group: 'player',
                    contents: {}
                },
                'Pictures': {
                    type: 'dir',
                    permissions: 'drwxr-xr-x',
                    owner: 'player',
                    group: 'player',
                    contents: {}
                },
                'Desktop': {
                    type: 'dir',
                    permissions: 'drwxr-xr-x',
                    owner: 'player',
                    group: 'player',
                    contents: {}
                }
            }
        };
    }

    initializeProcDirectory() {
        return {
            '1': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'root',
                group: 'root',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'root',
                        group: 'root',
                        content: '/sbin/init'
                    }
                }
            },
            '2': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'root',
                group: 'root',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'root',
                        group: 'root',
                        content: '[kthreadd]'
                    }
                }
            },
            '854': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'root',
                group: 'root',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'root',
                        group: 'root',
                        content: '/usr/sbin/sshd -D'
                    }
                }
            },
            '1024': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'mysql',
                group: 'mysql',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'mysql',
                        group: 'mysql',
                        content: 'mysqld'
                    }
                }
            },
            '1337': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'player',
                group: 'player',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'player',
                        group: 'player',
                        content: 'bash'
                    }
                }
            }
        };
    }

    getCurrentDir() {
        let path = this.currentDirectory === '~' ? '/home/player' : this.currentDirectory;
        let parts = path.split('/').filter(p => p);
        let current = this.fileSystem['/'];
        
        for (const part of parts) {
            if (part === 'home' || part === 'player') {
                current = current.contents[part];
            } else {
                current = current.contents[part];
            }
            if (!current) return null;
        }
        
        return current;
    }

    catFile(filename) {
        if (!filename) {
            return 'cat: missing operand\nTry \'cat --help\' for more information.';
        }

        const currentDir = this.getCurrentDir();
        if (!currentDir) return;

        // Handle path with directories
        if (filename.includes('/')) {
            const parts = filename.split('/').filter(p => p);
            let current = currentDir;
            
            // Handle absolute paths
            if (filename.startsWith('/')) {
                current = this.fileSystem['/'];
            }
            
            // Navigate through the path
            for (let i = 0; i < parts.length - 1; i++) {
                const part = parts[i];
                if (part === '..') {
                    // TODO: Implement directory up navigation
                    continue;
                } else if (part === '.') {
                    continue;
                } else {
                    current = current.contents[part];
                }
                
                if (!current || current.type !== 'dir') {
                    return `cat: ${filename}: No such file or directory`;
                }
            }
            
            filename = parts[parts.length - 1];
            currentDir = current;
        }

        const file = currentDir.contents[filename];
        
        if (!file) {
            return `cat: ${filename}: No such file or directory`;
        }

        if (file.type === 'dir') {
            return `cat: ${filename}: Is a directory`;
        }

        // Check if user has read permission
        const isOwner = file.owner === this.username;
        const isInGroup = file.group === this.username;
        const permissions = file.permissions;
        
        const canRead = (
            (isOwner && permissions[1] === 'r') ||
            (isInGroup && permissions[4] === 'r') ||
            permissions[7] === 'r'
        );

        if (!canRead) {
            return `cat: ${filename}: Permission denied`;
        }

        return file.content;
    }

    changeDirectory(path) {
        if (!path || path === '~' || path === '/home/player') {
            this.currentDirectory = '~';
        } else if (path === '..') {
            if (this.currentDirectory !== '~') {
                this.currentDirectory = this.currentDirectory.split('/').slice(0, -1).join('/') || '~';
            }
        } else if (path === '/') {
            this.currentDirectory = '/';
        } else if (path.startsWith('/')) {
            // Handle absolute paths
            const parts = path.split('/').filter(p => p);
            let current = this.fileSystem['/'];
            
            for (const part of parts) {
                if (!current.contents[part] || current.contents[part].type !== 'dir') {
                    return `cd: ${path}: No such directory`;
                }
                current = current.contents[part];
            }
            this.currentDirectory = path;
        } else {
            // Handle relative paths
            const dir = this.getCurrentDir();
            if (dir && dir.contents[path] && dir.contents[path].type === 'dir') {
                this.currentDirectory = this.currentDirectory === '~' ? 
                    `~/${path}` : `${this.currentDirectory}/${path}`;
            } else {
                return `cd: ${path}: No such directory`;
            }
        }
        this.updatePrompt();
    }

    listDirectory(args) {
        const showHidden = args.includes('-a') || args.includes('-la') || args.includes('-al');
        const showDetails = args.includes('-l') || args.includes('-la') || args.includes('-al');
        
        const dir = this.getCurrentDir();
        if (!dir) return;

        const files = Object.entries(dir.contents)
            .filter(([name]) => showHidden || !name.startsWith('.'))
            .map(([name, info]) => {
                if (showDetails) {
                    const type = info.type === 'dir' ? 'd' : '-';
                    const perms = type === 'd' ? 'rwxr-xr-x' : 'rw-r--r--';
                    const size = info.type === 'dir' ? '-' : info.content.length;
                    return `${type}${perms} ${this.username} ${this.username} ${size} Jan 18 10:33 ${name}`;
                }
                return name;
            });

        return files.join('\n') || 'Directory is empty';
    }

    listProcesses() {
        const header = '  PID TTY          TIME CMD';
        const processes = this.processes
            .filter(p => p.user === this.username)
            .map(p => `${p.pid.toString().padStart(5)} pts/0    00:00:00 ${p.command}`);
        return [header, ...processes].join('\n');
    }

    listNetworkConnections() {
        const header = 'Proto Recv-Q Send-Q Local Address           Foreign Address         State';
        const connections = this.networkConnections.map(c =>
            `${c.proto}        0      0 ${c.local.padEnd(22)} ${c.foreign.padEnd(22)} ${c.state}`
        );
        return [header, ...connections].join('\n');
    }

    listEnvironment() {
        const output = Object.entries(this.environment)
            .map(([key, value]) => `${key}=${value}`)
            .join('\n');
        return output;
    }

    ps(args) {
        // Parse options
        const options = new Set(args.join('').split(''));
        const showAll = options.has('a') || options.has('e');
        const showUser = options.has('u');
        const showAxu = args.includes('aux') || args.includes('aux');
        
        if (args.includes('--help')) {
            return this.psHelp();
        }

        // Format processes based on options
        let processes = [...this.processes];
        
        // Filter processes based on options
        if (!showAll && !showAxu) {
            processes = processes.filter(p => p.user === this.username);
        }

        // Different output formats based on options
        if (showAxu || showUser) {
            // Full format (ps aux)
            const now = new Date();
            const header = 'USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND';
            const formatted = processes.map(p => {
                const user = p.user.padEnd(8);
                const pid = p.pid.toString().padStart(5);
                const cpu = '0.0';
                const mem = '0.1';
                const vsz = '5000';
                const rss = '1000';
                const tty = 'pts/0';
                const stat = 'S+';
                const start = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                const time = '0:00';
                const command = p.command;
                
                return `${user} ${pid} ${cpu} ${mem} ${vsz} ${rss} ${tty} ${stat} ${start} ${time} ${command}`;
            });
            
            return [header, ...formatted].join('\n');
        } else {
            // Simple format (ps)
            const header = '  PID TTY          TIME CMD';
            const formatted = processes.map(p => {
                const pid = p.pid.toString().padStart(5);
                const tty = 'pts/0    ';
                const time = '00:00:00';
                const command = p.command;
                
                return `${pid} ${tty} ${time} ${command}`;
            });
            
            return [header, ...formatted].join('\n');
        }
    }

    psHelp() {
        return `Usage:
 ps [options]

Basic options:
 -e, -A              all processes
 a                   all w/ tty, including other users
 -a                  all w/ tty, except session leaders
 -d                  all except session leaders
 -N, --deselect     negate selection
 r                   only running processes
 T                   all processes on this terminal
 x                   processes without controlling ttys

Selection by list:
 -C <command>        command name
 -G, --Group <GID>   real group id or name
 -g, --group <group> session or effective group name
 p, p, --pid <PID>   process id
 -s, --sid <session> session id
 -t, t, --tty <tty>  terminal
 -u, U, --user <UID> effective user id or name
 -U, --User <UID>    real user id or name

Output formats:
 -F                  extra full
 -f                  full-format, including command lines
 u                   user-oriented
 v                   virtual memory format
 X                   register format
 -y                  do not show flags, show rss vs. addr (used with -l)
 --context          display security context (for SELinux)
 -Z, --context      same as --context
 -H                  show process hierarchy (forest)

For more details see ps(1).`;
    }

    chmod(mode, target) {
        if (!mode || !target) {
            return 'chmod: missing operand\nTry \'chmod --help\' for more information.';
        }

        if (mode === '--help') {
            return this.chmodHelp();
        }

        const currentDir = this.getCurrentDir();
        if (!currentDir) {
            return 'chmod: cannot access current directory';
        }

        // Handle path with directories
        const parts = target.split('/').filter(p => p);
        let targetDir = currentDir;
        let targetName = target;

        // Handle absolute paths and navigation
        if (target.startsWith('/')) {
            targetDir = this.fileSystem['/'];
            targetName = parts[parts.length - 1];
            parts.pop(); // Remove filename from parts

            // Navigate to target directory
            for (const part of parts) {
                if (!targetDir.contents[part] || targetDir.contents[part].type !== 'dir') {
                    return `chmod: cannot access '${target}': No such file or directory`;
                }
                targetDir = targetDir.contents[part];
            }
        } else if (parts.length > 1) {
            targetName = parts[parts.length - 1];
            parts.pop(); // Remove filename from parts

            // Navigate to target directory
            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                if (part === '..') {
                    // Go up one directory
                    const parentDir = this.getParentDir(targetDir);
                    if (!parentDir) {
                        return `chmod: cannot access '${target}': No such file or directory`;
                    }
                    targetDir = parentDir;
                } else if (part === '.') {
                    continue;
                } else {
                    if (!targetDir.contents[part] || targetDir.contents[part].type !== 'dir') {
                        return `chmod: cannot access '${target}': No such file or directory`;
                    }
                    targetDir = targetDir.contents[part];
                }
            }
        }

        const file = targetDir.contents[targetName];
        
        if (!file) {
            return `chmod: cannot access '${target}': No such file or directory`;
        }


        try {
            let newMode = '';
            if (/^[0-7]{3}$/.test(mode)) {
                // Octal mode (e.g., 644)
                const type = file.type === 'dir' ? 'd' : '-';
                newMode = type + this.octalToSymbolic(mode);
            } else if (/^[ugoa]*[-+=][rwx]+$/.test(mode)) {
                // Symbolic mode (e.g., u+rw)
                newMode = this.updateSymbolicMode(file.permissions, mode);
            } else {
                return `chmod: invalid mode: '${mode}'`;
            }

            file.permissions = newMode;
            return '';
        } catch (error) {
            return `chmod: invalid mode: '${mode}'`;
        }
    }

    octalToSymbolic(octal) {
        const mapping = {
            0: '---',
            1: '--x',
            2: '-w-',
            3: '-wx',
            4: 'r--',
            5: 'r-x',
            6: 'rw-',
            7: 'rwx'
        };
        
        return mapping[octal[0]] + mapping[octal[1]] + mapping[octal[2]];
    }

    updateSymbolicMode(currentMode, change) {
        // Keep the file type character
        const type = currentMode[0];
        const perms = currentMode.slice(1);
        
        // Parse the symbolic mode
        const match = change.match(/^([ugoa]*)([+-=])([rwx]+)$/);
        if (!match) {
            throw new Error('Invalid mode format');
        }

        const [, who, op, permissions] = match;
        const targets = who || 'a';

        // Define permission positions
        const positions = {
            u: [0, 1, 2],    // user
            g: [3, 4, 5],    // group
            o: [6, 7, 8],    // others
            a: [0, 1, 2, 3, 4, 5, 6, 7, 8]  // all
        };

        // Get affected positions
        const affectedPos = targets.split('').reduce((acc, t) => {
            return acc.concat(positions[t]);
        }, []);

        // Create new permission string
        let newPerms = perms.split('');
        
        for (const pos of new Set(affectedPos)) {
            const permType = pos % 3; // 0=r, 1=w, 2=x
            const perm = ['r', 'w', 'x'][permType];
            
            if (op === '=') {
                newPerms[pos] = permissions.includes(perm) ? perm : '-';
            } else if (op === '+' && permissions.includes(perm)) {
                newPerms[pos] = perm;
            } else if (op === '-' && permissions.includes(perm)) {
                newPerms[pos] = '-';
            }
        }

        return type + newPerms.join('');
    }

    chmodHelp() {
        return `Usage: chmod [OPTION]... MODE[,MODE]... FILE...
  or:  chmod [OPTION]... OCTAL-MODE FILE...
  or:  chmod [OPTION]... --reference=RFILE FILE...
Change the mode of each FILE to MODE.

Modes can be specified as:
  Octal:      chmod 644 file
  Symbolic:   chmod u+x file

Each MODE is of the form '[ugoa]*[-+=][rwx]':
  [ugoa]  - affects user/group/other/all
  [-+=]   - remove/add/set permissions
  [rwx]   - read/write/execute

Examples:
  chmod 644 file        - Set permissions to rw-r--r--
  chmod u+x file       - Add execute permission for owner
  chmod g-w file       - Remove write permission from group
  chmod a=rx file      - Set rx permissions for all
  chmod u+w,g+w file   - Add write permission for owner and group

Report bugs to: support@quicksnatch.com`;
    }
}

// Initialize terminal when document is ready
document.addEventListener('DOMContentLoaded', () => {
    window.terminal = new Terminal();
    terminal.init();
});
</script>
{% endblock %}
