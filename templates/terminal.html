<!-- Interactive Terminal Component -->
{% block terminal %}
<div class="terminal-container">
    <div class="terminal-header">
        <span class="terminal-title">user@quicksnatch:~$</span>
        <div class="terminal-controls">
            <button class="btn btn-sm" id="clear-terminal" title="Clear Terminal">
                <i class="fas fa-eraser"></i>
            </button>
            <button class="btn btn-sm" id="toggle-fullscreen" title="Toggle Fullscreen">
                <i class="fas fa-expand"></i>
            </button>
        </div>
    </div>
    <div class="terminal" id="terminal">
        <div class="terminal-output" id="terminal-output"></div>
        <div class="terminal-input-line">
            <span class="prompt">user@quicksnatch:~$ </span>
            <input type="text" id="terminal-input" autocomplete="off" spellcheck="false">
        </div>
    </div>
</div>

<script>
const terminal = {
    init: function() {
        this.output = document.getElementById('terminal-output');
        this.input = document.getElementById('terminal-input');
        this.commandHistory = [];
        this.historyIndex = -1;
        this.setupEventListeners();
        this.welcomeMessage();
    },

    setupEventListeners: function() {
        this.input.addEventListener('keydown', (e) => this.handleInput(e));
        document.getElementById('clear-terminal').addEventListener('click', () => this.clear());
        document.getElementById('toggle-fullscreen').addEventListener('click', () => this.toggleFullscreen());
        
        // Tab completion
        this.input.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                this.handleTabCompletion();
            }
        });
    },

    welcomeMessage: function() {
        const messages = [
            'QuickSnatch Terminal v2.0',
            'Type "help" for available commands',
            ''
        ];
        this.appendOutput(messages.join('\n'));
    },

    handleInput: function(e) {
        if (e.key === 'Enter') {
            const command = this.input.value.trim();
            if (command) {
                this.commandHistory.push(command);
                this.historyIndex = this.commandHistory.length;
                this.executeCommand(command);
                this.input.value = '';
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (this.historyIndex > 0) {
                this.historyIndex--;
                this.input.value = this.commandHistory[this.historyIndex];
            }
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (this.historyIndex < this.commandHistory.length - 1) {
                this.historyIndex++;
                this.input.value = this.commandHistory[this.historyIndex];
            } else {
                this.historyIndex = this.commandHistory.length;
                this.input.value = '';
            }
        }
    },

    executeCommand: function(command) {
        this.appendOutput(`user@quicksnatch:~$ ${command}`);
        
        const [cmd, ...args] = command.split(' ');
        
        switch (cmd.toLowerCase()) {
            case 'help':
                this.showHelp();
                break;
            case 'clear':
                this.clear();
                break;
            case 'strings':
                this.runStrings(args[0]);
                break;
            case 'hexdump':
                this.runHexdump(args);
                break;
            case 'file':
                this.runFile(args[0]);
                break;
            case 'objdump':
                this.runObjdump(args);
                break;
            case 'readelf':
                this.runReadelf(args);
                break;
            case 'ls':
                this.runLs(args);
                break;
            case 'cat':
                this.runCat(args[0]);
                break;
            default:
                this.appendOutput(`Command not found: ${cmd}. Type "help" for available commands.`);
        }
    },

    showHelp: function() {
        const help = [
            'Available commands:',
            '  strings <file>     - Extract readable strings',
            '  hexdump -C <file>  - Display file contents in hex',
            '  file <file>        - Determine file type',
            '  objdump -d <file>  - Disassemble binary',
            '  readelf -a <file>  - Display ELF file information',
            '  ls [dir]           - List directory contents',
            '  cat <file>         - Display file contents',
            '  clear             - Clear terminal',
            '  help              - Show this help message',
            ''
        ];
        this.appendOutput(help.join('\n'));
    },

    runStrings: function(file) {
        if (!file) {
            this.appendOutput('Usage: strings <file>');
            return;
        }
        
        fetch('/analyze_binary', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tool: 'find-strings' })
        })
        .then(response => response.json())
        .then(data => {
            if (data[0] && data[0].content) {
                this.appendOutput(data[0].content);
            }
        });
    },

    runHexdump: function(args) {
        if (!args.includes('-C') || !args[1]) {
            this.appendOutput('Usage: hexdump -C <file>');
            return;
        }
        
        fetch('/get_binary_data')
        .then(response => response.arrayBuffer())
        .then(data => {
            const view = new Uint8Array(data);
            let output = [];
            
            for (let i = 0; i < view.length; i += 16) {
                const hex = Array.from(view.slice(i, i + 16))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join(' ');
                    
                const ascii = Array.from(view.slice(i, i + 16))
                    .map(b => b >= 32 && b <= 126 ? String.fromCharCode(b) : '.')
                    .join('');
                    
                output.push(`${i.toString(16).padStart(8, '0')}  ${hex.padEnd(48, ' ')}  |${ascii}|`);
            }
            
            this.appendOutput(output.join('\n'));
        });
    },

    runFile: function(file) {
        if (!file) {
            this.appendOutput('Usage: file <file>');
            return;
        }
        
        fetch('/analyze_binary', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tool: 'check-headers' })
        })
        .then(response => response.json())
        .then(data => {
            if (data[0] && data[0].content) {
                this.appendOutput(data[0].content);
            }
        });
    },

    runObjdump: function(args) {
        if (!args.includes('-d') || !args[1]) {
            this.appendOutput('Usage: objdump -d <file>');
            return;
        }
        
        // Simulated disassembly output
        const disasm = [
            'Disassembly of section .text:',
            '',
            '0000000000001000 <_start>:',
            '    1000:    31 ed           xor    %ebp,%ebp',
            '    1002:    49 89 d1        mov    %rdx,%r9',
            '    1005:    5e              pop    %rsi',
            '    1006:    48 89 e2        mov    %rsp,%rdx',
            '    1009:    48 83 e4 f0     and    $0xfffffffffffffff0,%rsp',
            ''
        ];
        this.appendOutput(disasm.join('\n'));
    },

    runReadelf: function(args) {
        if (!args.includes('-a') || !args[1]) {
            this.appendOutput('Usage: readelf -a <file>');
            return;
        }
        
        // Simulated ELF header output
        const elfInfo = [
            'ELF Header:',
            '  Magic:   7f 45 4c 46 02 01 01 00',
            '  Class:                             ELF64',
            '  Data:                              2\'s complement, little endian',
            '  Version:                           1 (current)',
            '  OS/ABI:                           UNIX - System V',
            '  ABI Version:                       0',
            ''
        ];
        this.appendOutput(elfInfo.join('\n'));
    },

    runLs: function(args) {
        const files = [
            'binary',
            'strings.txt',
            'dump.hex',
            'analysis.log'
        ];
        this.appendOutput(files.join('  '));
    },

    runCat: function(file) {
        if (!file) {
            this.appendOutput('Usage: cat <file>');
            return;
        }
        
        if (file === 'strings.txt') {
            this.runStrings(file);
        } else {
            this.appendOutput(`cat: ${file}: No such file or directory`);
        }
    },

    handleTabCompletion: function() {
        const input = this.input.value;
        const commands = ['strings', 'hexdump', 'file', 'objdump', 'readelf', 'ls', 'cat', 'clear', 'help'];
        const files = ['binary', 'strings.txt', 'dump.hex', 'analysis.log'];
        
        const [cmd, arg] = input.split(' ');
        
        if (!arg) {
            const matches = commands.filter(c => c.startsWith(cmd));
            if (matches.length === 1) {
                this.input.value = matches[0] + ' ';
            }
        } else {
            const matches = files.filter(f => f.startsWith(arg));
            if (matches.length === 1) {
                this.input.value = cmd + ' ' + matches[0];
            }
        }
    },

    appendOutput: function(text) {
        const output = document.createElement('div');
        output.textContent = text;
        this.output.appendChild(output);
        this.output.scrollTop = this.output.scrollHeight;
    },

    clear: function() {
        this.output.innerHTML = '';
        this.welcomeMessage();
    },

    toggleFullscreen: function() {
        const container = document.querySelector('.terminal-container');
        container.classList.toggle('fullscreen');
        const icon = document.querySelector('#toggle-fullscreen i');
        icon.classList.toggle('fa-expand');
        icon.classList.toggle('fa-compress');
    }
};

document.addEventListener('DOMContentLoaded', function() {
    terminal.init();
});
</script>

<style>
.terminal-container {
    background: rgba(0, 0, 0, 0.9);
    border-radius: 6px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.terminal-container.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    border-radius: 0;
}

.terminal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.terminal-title {
    color: #ecf0f1;
    font-family: 'Source Code Pro', monospace;
    font-size: 0.9rem;
}

.terminal-controls button {
    background: none;
    border: none;
    color: #ecf0f1;
    padding: 0.25rem 0.5rem;
    margin-left: 0.5rem;
    opacity: 0.7;
    transition: opacity 0.2s ease;
}

.terminal-controls button:hover {
    opacity: 1;
}

.terminal {
    height: 400px;
    padding: 1rem;
    overflow-y: auto;
    font-family: 'Source Code Pro', monospace;
    font-size: 0.9rem;
    line-height: 1.4;
}

.terminal-container.fullscreen .terminal {
    height: calc(100vh - 40px);
}

.terminal-output {
    color: #ecf0f1;
    white-space: pre-wrap;
    margin-bottom: 1rem;
}

.terminal-input-line {
    display: flex;
    align-items: center;
}

.prompt {
    color: #2ecc71;
    margin-right: 0.5rem;
}

#terminal-input {
    flex: 1;
    background: none;
    border: none;
    color: #ecf0f1;
    font-family: inherit;
    font-size: inherit;
    padding: 0;
    margin: 0;
}

#terminal-input:focus {
    outline: none;
}

/* Scrollbar Styles */
.terminal::-webkit-scrollbar {
    width: 8px;
}

.terminal::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
}

.terminal::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
}

.terminal::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
}
</style>
{% endblock %}
