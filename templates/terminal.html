<!-- Interactive Terminal Component -->
{% block terminal %}
<div class="terminal-wrapper">
    <!-- Terminal Window -->
    <div id="terminal">
        <div class="terminal-header">
            <div class="terminal-title">QuickSnatch Terminal - Level {{ level }}</div>
            <div class="terminal-controls">
                <span class="control minimize">−</span>
                <span class="control maximize">□</span>
                <span class="control close">×</span>
            </div>
        </div>
        <div class="terminal-content">
            <div class="terminal-output"></div>
            <div class="terminal-input-line">
                <span class="prompt"></span>
                <input type="text" id="terminal-input" autocomplete="off" spellcheck="false" autofocus>
            </div>
            <div class="suggestions" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- Terminal Styles -->
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/terminal.css') }}">

<!-- Terminal Scripts -->
<script>
class Terminal {
    constructor() {
        this.level = {{ level }};
        this.username = 'player';
        this.hostname = 'quicksnatch';
        this.history = [];
        this.historyIndex = -1;
        this.commandBuffer = '';
        this.currentDirectory = '~';
        this.fileSystem = this.initializeFileSystem();
        this.processes = this.initializeProcesses();
        this.networkConnections = this.initializeNetwork();
        this.environment = this.initializeEnvironment();
        this.services = this.initializeServices();
        this.aliases = {
            ll: 'ls -l',
            la: 'ls -a',
            lla: 'ls -la',
            l: 'ls',
            c: 'clear'
        };
        
        // Command suggestions
        this.suggestions = [];
        this.selectedSuggestionIndex = -1;
    }

    init() {
        this.terminal = document.getElementById('terminal');
        this.output = document.querySelector('.terminal-output');
        this.input = document.getElementById('terminal-input');
        this.prompt = document.querySelector('.prompt');
        this.suggestionsDiv = document.querySelector('.suggestions');

        this.updatePrompt();
        this.setupEventListeners();
        this.welcomeMessage();
    }

    setupEventListeners() {
        this.input.addEventListener('keydown', (e) => this.handleKeyDown(e));
        this.input.addEventListener('input', () => this.handleInput());
        
        // Terminal controls
        document.querySelector('.close').addEventListener('click', () => this.handleClose());
        document.querySelector('.minimize').addEventListener('click', () => this.handleMinimize());
        document.querySelector('.maximize').addEventListener('click', () => this.handleMaximize());
    }

    handleKeyDown(e) {
        switch(e.key) {
            case 'Enter':
                e.preventDefault();
                this.executeCommand();
                break;
            case 'ArrowUp':
                e.preventDefault();
                this.navigateHistory(-1);
                break;
            case 'ArrowDown':
                e.preventDefault();
                this.navigateHistory(1);
                break;
            case 'Tab':
                e.preventDefault();
                this.handleTabCompletion();
                break;
            case 'c':
                if (e.ctrlKey) {
                    e.preventDefault();
                    this.handleCtrlC();
                }
                break;
            case 'l':
                if (e.ctrlKey) {
                    e.preventDefault();
                    this.clear();
                }
                break;
        }
    }

    handleInput() {
        const input = this.input.value.trim();
        this.showSuggestions(input);
    }

    showSuggestions(input) {
        if (!input) {
            this.suggestionsDiv.style.display = 'none';
            return;
        }

        const commands = [
            'ls', 'cd', 'pwd', 'echo', 'cat', 'help', 'clear',
            'ps', 'netstat', 'env', 'whoami', 'date', 'history',
            ...Object.keys(this.aliases)
        ];

        this.suggestions = commands.filter(cmd => cmd.startsWith(input));
        
        if (this.suggestions.length > 0) {
            this.suggestionsDiv.innerHTML = this.suggestions
                .map((s, i) => `<div class="suggestion-item${i === this.selectedSuggestionIndex ? ' selected' : ''}">${s}</div>`)
                .join('');
            this.suggestionsDiv.style.display = 'block';
        } else {
            this.suggestionsDiv.style.display = 'none';
        }
    }

    handleTabCompletion() {
        if (this.suggestions.length === 1) {
            this.input.value = this.suggestions[0];
            this.suggestionsDiv.style.display = 'none';
        }
    }

    updatePrompt() {
        this.prompt.textContent = `${this.username}@${this.hostname}:${this.currentDirectory}$ `;
    }

    executeCommand() {
        const command = this.input.value.trim();
        if (!command) return;

        this.addToHistory(command);
        this.writeOutput(`${this.prompt.textContent}${command}`);

        const output = this.processCommand(command);
        if (output) {
            this.writeOutput(output);
        }

        this.input.value = '';
        this.suggestionsDiv.style.display = 'none';
        this.updatePrompt();
    }

    processCommand(command) {
        // Handle aliases
        if (this.aliases[command]) {
            command = this.aliases[command];
        }

        const [cmd, ...args] = command.split(' ');

        switch(cmd) {
            case 'clear':
                this.clear();
                return '';
            case 'help':
                return this.getHelpText();
            case 'ls':
                return this.listDirectory(args);
            case 'pwd':
                return this.currentDirectory;
            case 'cd':
                return this.changeDirectory(args[0]);
            case 'echo':
                return args.join(' ');
            case 'whoami':
                return this.username;
            case 'date':
                return new Date().toString();
            case 'history':
                return this.history.join('\n');
            case 'ps':
                return this.listProcesses();
            case 'netstat':
                return this.listNetworkConnections();
            case 'env':
                return this.listEnvironment();
            default:
                return `Command not found: ${cmd}. Type 'help' for available commands.`;
        }
    }

    writeOutput(text, className = '') {
        const line = document.createElement('div');
        line.textContent = text;
        if (className) line.className = className;
        this.output.appendChild(line);
        this.terminal.querySelector('.terminal-content').scrollTop = this.terminal.querySelector('.terminal-content').scrollHeight;
    }

    clear() {
        this.output.innerHTML = '';
    }

    addToHistory(command) {
        this.history.push(command);
        if (this.history.length > 100) {
            this.history.shift();
        }
        this.historyIndex = this.history.length;
    }

    navigateHistory(direction) {
        const newIndex = this.historyIndex + direction;
        if (newIndex >= 0 && newIndex <= this.history.length) {
            this.historyIndex = newIndex;
            this.input.value = this.historyIndex === this.history.length ? this.commandBuffer : this.history[this.historyIndex];
        }
    }

    handleCtrlC() {
        this.writeOutput(`^C`);
        this.input.value = '';
        this.updatePrompt();
    }

    handleClose() {
        // Implement close behavior
        this.writeOutput('Terminal cannot be closed in challenge mode', 'error');
    }

    handleMinimize() {
        this.terminal.style.opacity = '0.8';
    }

    handleMaximize() {
        this.terminal.style.opacity = '1';
        // Toggle fullscreen logic here
    }

    welcomeMessage() {
        const messages = [
            `Welcome to QuickSnatch Terminal - Level ${this.level}`,
            'Type "help" for available commands',
            ''
        ];
        messages.forEach(msg => this.writeOutput(msg));
    }

    getHelpText() {
        return `
Available commands:
  ls      - List directory contents
  cd      - Change directory
  pwd     - Print working directory
  echo    - Display a message
  clear   - Clear terminal screen
  help    - Show this help message
  whoami  - Display current user
  date    - Show current date/time
  history - Show command history
  ps      - List running processes
  netstat - List network connections
  env     - List environment variables

Shortcuts:
  Ctrl+C  - Cancel current command
  Ctrl+L  - Clear screen
  Tab     - Command completion
  ↑/↓     - Navigate command history

Aliases:
${Object.entries(this.aliases).map(([alias, cmd]) => `  ${alias}     - ${cmd}`).join('\n')}
`;
    }

    initializeEnvironment() {
        return {
            'HOME': '/home/player',
            'USER': 'player',
            'SHELL': '/bin/bash',
            'PWD': '/home/player',
            'LANG': 'en_US.UTF-8',
            'TERM': 'xterm-256color',
            'PATH': '/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin',
            'EDITOR': 'vim',
            'HISTSIZE': '1000',
            'HISTFILESIZE': '2000',
            'PS1': '\\u@\\h:\\w\\$ ',
            'LEVEL': this.level.toString(),
            ...this.getLevelSpecificEnv()
        };
    }

    getLevelSpecificEnv() {
        switch(this.level) {
            case 6:
                return {
                    'SECRET_TOKEN': 'FLAG{env_master_found_me}',
                    'DB_PASSWORD': 'supersecret123',
                    'API_KEY': 'abcdef123456'
                };
            case 7:
                return {
                    'SERVICE_PORT': '31337',
                    'SERVICE_TOKEN': 'FLAG{service_auth_master}'
                };
            case 8:
                return {
                    'MYSQL_USER': 'player',
                    'MYSQL_PASSWORD': 'FLAG{sql_master_found_me}'
                };
            default:
                return {};
        }
    }

    initializeProcesses() {
        const baseProcesses = [
            { pid: 1, user: 'root', command: '/sbin/init' },
            { pid: 2, user: 'root', command: '[kthreadd]' },
            { pid: 854, user: 'root', command: '/usr/sbin/sshd -D' },
            { pid: 1024, user: 'mysql', command: 'mysqld' },
            { pid: 1337, user: 'player', command: 'bash' }
        ];

        if (this.level >= 4) {
            baseProcesses.push(
                { pid: 1234, user: 'player', command: '/usr/bin/suspicious_process --flag=FLAG{process_hunter_success}' }
            );
        }

        return baseProcesses;
    }

    initializeNetwork() {
        const baseConnections = [
            { proto: 'tcp', local: '0.0.0.0:22', foreign: '0.0.0.0:*', state: 'LISTEN' },
            { proto: 'tcp6', local: ':::80', foreign: ':::*', state: 'LISTEN' }
        ];

        if (this.level >= 5) {
            baseConnections.push(
                { proto: 'tcp', local: '127.0.0.1:12345', foreign: '0.0.0.0:*', state: 'LISTEN' }
            );
        }

        return baseConnections;
    }

    initializeServices() {
        const baseServices = [
            { name: 'ssh', status: 'running', port: 22 },
            { name: 'nginx', status: 'running', port: 80 }
        ];

        if (this.level >= 7) {
            baseServices.push(
                { name: 'flag-service', status: 'running', port: 31337 }
            );
        }

        return baseServices;
    }

    initializeFileSystem() {
        const fs = {
            '/': {
                type: 'dir',
                permissions: 'drwxr-xr-x',
                owner: 'root',
                group: 'root',
                contents: {
                    'bin': {
                        type: 'dir',
                        permissions: 'drwxr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: {
                            'bash': { type: 'file', permissions: '-rwxr-xr-x', owner: 'root', group: 'root', content: 'ELF...' },
                            'ls': { type: 'file', permissions: '-rwxr-xr-x', owner: 'root', group: 'root', content: 'ELF...' }
                        }
                    },
                    'etc': {
                        type: 'dir',
                        permissions: 'drwxr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: {
                            'passwd': {
                                type: 'file',
                                permissions: '-rw-r--r--',
                                owner: 'root',
                                group: 'root',
                                content: 'root:x:0:0:root:/root:/bin/bash\nplayer:x:1000:1000:Player,,,:/home/player:/bin/bash'
                            },
                            'shadow': {
                                type: 'file',
                                permissions: '-rw-r-----',
                                owner: 'root',
                                group: 'shadow',
                                content: 'root:$6$xyz...\nplayer:$6$abc...'
                            },
                            'hostname': {
                                type: 'file',
                                permissions: '-rw-r--r--',
                                owner: 'root',
                                group: 'root',
                                content: 'quicksnatch'
                            }
                        }
                    },
                    'home': {
                        type: 'dir',
                        permissions: 'drwxr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: {
                            'player': this.initializeHomeDirectory()
                        }
                    },
                    'proc': {
                        type: 'dir',
                        permissions: 'dr-xr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: this.initializeProcDirectory()
                    },
                    'var': {
                        type: 'dir',
                        permissions: 'drwxr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: {
                            'log': {
                                type: 'dir',
                                permissions: 'drwxr-xr-x',
                                owner: 'root',
                                group: 'root',
                                contents: {
                                    'auth.log': {
                                        type: 'file',
                                        permissions: '-rw-r--r--',
                                        owner: 'root',
                                        group: 'root',
                                        content: 'Jan 18 10:42:01 quicksnatch sshd[854]: Server listening on 0.0.0.0 port 22.'
                                    }
                                }
                            }
                        }
                    }
                }
            }
        };

        // Add level-specific files
        this.addLevelSpecificFiles(fs);
        return fs;
    }

    addLevelSpecificFiles(fs) {
        // Add level-specific files here
    }

    initializeHomeDirectory() {
        return {
            type: 'dir',
            permissions: 'drwxr-xr-x',
            owner: 'player',
            group: 'player',
            contents: {
                'Documents': {
                    type: 'dir',
                    permissions: 'drwxr-xr-x',
                    owner: 'player',
                    group: 'player',
                    contents: {}
                },
                'Pictures': {
                    type: 'dir',
                    permissions: 'drwxr-xr-x',
                    owner: 'player',
                    group: 'player',
                    contents: {}
                },
                'Desktop': {
                    type: 'dir',
                    permissions: 'drwxr-xr-x',
                    owner: 'player',
                    group: 'player',
                    contents: {}
                }
            }
        };
    }

    initializeProcDirectory() {
        return {
            '1': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'root',
                group: 'root',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'root',
                        group: 'root',
                        content: '/sbin/init'
                    }
                }
            },
            '2': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'root',
                group: 'root',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'root',
                        group: 'root',
                        content: '[kthreadd]'
                    }
                }
            },
            '854': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'root',
                group: 'root',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'root',
                        group: 'root',
                        content: '/usr/sbin/sshd -D'
                    }
                }
            },
            '1024': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'mysql',
                group: 'mysql',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'mysql',
                        group: 'mysql',
                        content: 'mysqld'
                    }
                }
            },
            '1337': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'player',
                group: 'player',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'player',
                        group: 'player',
                        content: 'bash'
                    }
                }
            }
        };
    }

    listDirectory(args) {
        const showHidden = args.includes('-a') || args.includes('-la') || args.includes('-al');
        const showDetails = args.includes('-l') || args.includes('-la') || args.includes('-al');
        
        const dir = this.getCurrentDir();
        if (!dir) return;

        const files = Object.entries(dir.contents)
            .filter(([name]) => showHidden || !name.startsWith('.'))
            .map(([name, info]) => {
                if (showDetails) {
                    const type = info.type === 'dir' ? 'd' : '-';
                    const perms = type === 'd' ? 'rwxr-xr-x' : 'rw-r--r--';
                    const size = info.type === 'dir' ? '-' : info.content.length;
                    return `${type}${perms} ${this.username} ${this.username} ${size} Jan 18 10:33 ${name}`;
                }
                return name;
            });

        return files.join('\n') || 'Directory is empty';
    }

    getCurrentDir() {
        if (this.currentDirectory === '~') {
            return this.fileSystem['/'].contents.home.contents.player;
        } else if (this.currentDirectory === '/') {
            return this.fileSystem['/'];
        }
        
        const parts = this.currentDirectory.replace('~', '/home/player').split('/').filter(Boolean);
        let current = this.fileSystem['/'];
        
        for (const part of parts) {
            if (!current.contents[part]) return null;
            current = current.contents[part];
        }
        
        return current;
    }

    changeDirectory(path) {
        if (!path || path === '~' || path === '/home/player') {
            this.currentDirectory = '~';
        } else if (path === '..') {
            if (this.currentDirectory !== '~') {
                this.currentDirectory = this.currentDirectory.split('/').slice(0, -1).join('/') || '~';
            }
        } else if (path === '/') {
            this.currentDirectory = '/';
        } else if (path.startsWith('/')) {
            // Handle absolute paths
            const parts = path.split('/').filter(Boolean);
            let current = this.fileSystem['/'];
            
            for (const part of parts) {
                if (!current.contents[part] || current.contents[part].type !== 'dir') {
                    return `cd: ${path}: No such directory`;
                }
                current = current.contents[part];
            }
            this.currentDirectory = path;
        } else {
            // Handle relative paths
            const dir = this.getCurrentDir();
            if (dir && dir.contents[path] && dir.contents[path].type === 'dir') {
                this.currentDirectory = this.currentDirectory === '~' ? 
                    `~/${path}` : `${this.currentDirectory}/${path}`;
            } else {
                return `cd: ${path}: No such directory`;
            }
        }
        this.updatePrompt();
    }

    listProcesses() {
        const header = '  PID TTY          TIME CMD';
        const processes = this.processes
            .filter(p => p.user === this.username)
            .map(p => `${p.pid.toString().padEnd(5)} pts/0    00:00:00 ${p.command.split('/').pop()}`);
        return [header, ...processes].join('\n');
    }

    listNetworkConnections() {
        const header = 'Proto Recv-Q Send-Q Local Address           Foreign Address         State';
        const connections = this.networkConnections.map(c =>
            `${c.proto.padEnd(6)} 0      0 ${c.local.padEnd(22)} ${c.foreign.padEnd(22)} ${c.state}`
        );
        return [header, ...connections].join('\n');
    }

    listEnvironment() {
        const output = Object.entries(this.environment)
            .map(([key, value]) => `${key}=${value}`)
            .join('\n');
        return output;
    }
}

// Initialize terminal when document is ready
document.addEventListener('DOMContentLoaded', () => {
    window.terminal = new Terminal();
    terminal.init();
});
</script>
{% endblock %}
