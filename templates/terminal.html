<!-- Interactive Terminal Component -->
{% block terminal %}
<div class="terminal-wrapper">
    <!-- Terminal Window -->
    <div id="terminal">
        <div class="terminal-header">
            <div class="terminal-title">QuickSnatch Terminal - Level {{ level }}</div>
            <div class="terminal-controls">
                <span class="control minimize">−</span>
                <span class="control maximize">□</span>
                <span class="control close">×</span>
            </div>
        </div>
        <div class="terminal-content">
            <div class="terminal-output"></div>
            <div class="terminal-input-line">
                <span class="prompt"></span>
                <input type="text" id="terminal-input" autocomplete="off" spellcheck="false" autofocus>
            </div>
            <div class="suggestions" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- Terminal Styles -->
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/terminal.css') }}">

<!-- Terminal Scripts -->
<script>
class Terminal {
    constructor() {
        this.level = {{ level }};
        this.username = 'player';
        this.hostname = 'quicksnatch';
        this.history = [];
        this.historyIndex = -1;
        this.commandBuffer = '';
        this.currentDirectory = '~';
        this.fileSystem = this.initializeFileSystem();
        this.processes = this.initializeProcesses();
        this.networkConnections = this.initializeNetwork();
        this.environment = this.initializeEnvironment();
        this.services = this.initializeServices();
        this.aliases = {
            ll: 'ls -l',
            la: 'ls -a',
            lla: 'ls -la',
            l: 'ls',
            c: 'clear'
        };
        
        // Command suggestions
        this.suggestions = [];
        this.selectedSuggestionIndex = -1;
    }

    init() {
        this.terminal = document.getElementById('terminal');
        this.output = document.querySelector('.terminal-output');
        this.input = document.getElementById('terminal-input');
        this.prompt = document.querySelector('.prompt');
        this.suggestionsDiv = document.querySelector('.suggestions');

        this.updatePrompt();
        this.setupEventListeners();
        this.welcomeMessage();
    }

    setupEventListeners() {
        this.input.addEventListener('keydown', (e) => this.handleKeyDown(e));
        this.input.addEventListener('input', () => this.handleInput());
        
        // Terminal controls
        document.querySelector('.close').addEventListener('click', () => this.handleClose());
        document.querySelector('.minimize').addEventListener('click', () => this.handleMinimize());
        document.querySelector('.maximize').addEventListener('click', () => this.handleMaximize());
    }

    handleKeyDown(e) {
        switch(e.key) {
            case 'Enter':
                e.preventDefault();
                this.executeCommand();
                break;
            case 'ArrowUp':
                e.preventDefault();
                this.navigateHistory(-1);
                break;
            case 'ArrowDown':
                e.preventDefault();
                this.navigateHistory(1);
                break;
            case 'Tab':
                e.preventDefault();
                this.handleTabCompletion();
                break;
            case 'c':
                if (e.ctrlKey) {
                    e.preventDefault();
                    this.handleCtrlC();
                }
                break;
            case 'l':
                if (e.ctrlKey) {
                    e.preventDefault();
                    this.clear();
                }
                break;
        }
    }

    handleInput() {
        const input = this.input.value.trim();
        this.showSuggestions(input);
    }

    showSuggestions(input) {
        if (!input) {
            this.suggestionsDiv.style.display = 'none';
            return;
        }

        const commands = [
            'ls', 'cd', 'pwd', 'echo', 'cat', 'help', 'clear',
            'ps', 'netstat', 'env', 'whoami', 'date', 'history',
            ...Object.keys(this.aliases)
        ];

        this.suggestions = commands.filter(cmd => cmd.startsWith(input));
        
        if (this.suggestions.length > 0) {
            this.suggestionsDiv.innerHTML = this.suggestions
                .map((s, i) => `<div class="suggestion-item${i === this.selectedSuggestionIndex ? ' selected' : ''}">${s}</div>`)
                .join('');
            this.suggestionsDiv.style.display = 'block';
        } else {
            this.suggestionsDiv.style.display = 'none';
        }
    }

    handleTabCompletion() {
        if (this.suggestions.length === 1) {
            this.input.value = this.suggestions[0];
            this.suggestionsDiv.style.display = 'none';
        }
    }

    updatePrompt() {
        this.prompt.textContent = `${this.username}@${this.hostname}:${this.currentDirectory}$ `;
    }

    executeCommand() {
        const command = this.input.value.trim();
        if (!command) return;

        this.addToHistory(command);
        this.writeOutput(`${this.prompt.textContent}${command}`);

        const output = this.processCommand(command);
        if (output) {
            this.writeOutput(output);
        }

        this.input.value = '';
        this.suggestionsDiv.style.display = 'none';
        this.updatePrompt();
    }

    processCommand(command) {
        // Handle aliases
        if (this.aliases[command]) {
            command = this.aliases[command];
        }

        const [cmd, ...args] = command.split(' ');

        // Add level-specific command handling
        switch(this.level) {
            case 4:
                if (cmd === 'ps') {
                    return this.listProcesses(true); // Show suspicious process
                }
                break;
            case 5:
                if (cmd === 'netstat') {
                    return this.listNetworkConnections(true); // Show hidden service
                }
                break;
            case 6:
                if (cmd === 'env' || cmd === 'printenv') {
                    return this.listEnvironment(true); // Show secret variable
                }
                break;
            case 8:
                if (cmd === 'mysql') {
                    return this.handleMySQLCommand(args);
                }
                break;
            case 9:
                if (cmd === 'base64' && args[0] === '-d') {
                    return this.handleBase64Decode(args.slice(1));
                }
                break;
            case 10:
                if (cmd === 'git') {
                    return this.handleGitCommand(args);
                }
                break;
        }

        // Default command handling
        switch(cmd) {
            case 'clear':
                this.clear();
                return '';
            case 'help':
                return this.getHelpText();
            case 'ls':
                return this.listDirectory(args);
            case 'pwd':
                return this.currentDirectory;
            case 'cd':
                return this.changeDirectory(args[0]);
            case 'cat':
                return this.catFile(args[0]);
            case 'chmod':
                return this.chmod(args[0], args[1]);
            case 'grep':
                return this.grep(args);
            case 'echo':
                return args.join(' ');
            case 'whoami':
                return this.username;
            case 'date':
                return new Date().toString();
            case 'history':
                return this.history.join('\n');
            case 'ps':
                return this.ps(args);
            case 'netstat':
                return this.netstat(args);
            case 'env':
            case 'printenv':
                return this.listEnvironment();
            default:
                return `Command not found: ${cmd}. Type 'help' for available commands.`;
        }
    }

    writeOutput(text, className = '') {
        const line = document.createElement('div');
        line.textContent = text;
        if (className) line.className = className;
        this.output.appendChild(line);
        this.terminal.querySelector('.terminal-content').scrollTop = this.terminal.querySelector('.terminal-content').scrollHeight;
    }

    clear() {
        this.output.innerHTML = '';
    }

    addToHistory(command) {
        this.history.push(command);
        if (this.history.length > 100) {
            this.history.shift();
        }
        this.historyIndex = this.history.length;
    }

    navigateHistory(direction) {
        const newIndex = this.historyIndex + direction;
        if (newIndex >= 0 && newIndex <= this.history.length) {
            this.historyIndex = newIndex;
            this.input.value = this.historyIndex === this.history.length ? this.commandBuffer : this.history[this.historyIndex];
        }
    }

    handleCtrlC() {
        this.writeOutput(`^C`);
        this.input.value = '';
        this.updatePrompt();
    }

    handleClose() {
        // Implement close behavior
        this.writeOutput('Terminal cannot be closed in challenge mode', 'error');
    }

    handleMinimize() {
        this.terminal.style.opacity = '0.8';
    }

    handleMaximize() {
        this.terminal.style.opacity = '1';
        // Toggle fullscreen logic here
    }

    welcomeMessage() {
        const messages = this.welcomeMessages[this.level] || [
            `Welcome to QuickSnatch Terminal - Level ${this.level}`,
            'Type "help" for available commands',
            ''
        ];
        messages.forEach(msg => this.writeOutput(msg));
    }

    getHelpText() {
        return `
Available commands:
  ls      - List directory contents
  cd      - Change directory
  pwd     - Print working directory
  echo    - Display a message
  clear   - Clear terminal screen
  help    - Show this help message
  whoami  - Display current user
  date    - Show current date/time
  history - Show command history
  ps      - List running processes
  netstat - List network connections
  env     - List environment variables
  chmod   - Change file permissions
  cat     - Display file contents
  grep    - Search for patterns in files

Shortcuts:
  Ctrl+C  - Cancel current command
  Ctrl+L  - Clear screen
  Tab     - Command completion
  ↑/↓     - Navigate command history

Aliases:
${Object.entries(this.aliases).map(([alias, cmd]) => `  ${alias}     - ${cmd}`).join('\n')}
`;
    }

    initializeEnvironment() {
        return {
            'HOME': '/home/player',
            'USER': 'player',
            'SHELL': '/bin/bash',
            'PWD': '/home/player',
            'LANG': 'en_US.UTF-8',
            'TERM': 'xterm-256color',
            'PATH': '/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin',
            'EDITOR': 'vim',
            'HISTSIZE': '1000',
            'HISTFILESIZE': '2000',
            'PS1': '\\u@\\h:\\w\\$ ',
            'LEVEL': this.level.toString(),
            ...this.getLevelSpecificEnv()
        };
    }

    getLevelSpecificEnv() {
        switch(this.level) {
            case 6:
                return {
                    'SECRET_TOKEN': 'flag{env_master_found_me}',
                    'DB_PASSWORD': 'supersecret123',
                    'API_KEY': 'abcdef123456'
                };
            case 7:
                return {
                    'SERVICE_PORT': '31337',
                    'SERVICE_TOKEN': 'flag{service_auth_master}'
                };
            case 8:
                return {
                    'MYSQL_USER': 'player',
                    'MYSQL_PASSWORD': 'flag{sql_master_found_me}'
                };
            default:
                return {};
        }
    }

    initializeProcesses() {
        const baseProcesses = [
            { pid: 1, user: 'root', command: '/sbin/init' },
            { pid: 2, user: 'root', command: '[kthreadd]' },
            { pid: 854, user: 'root', command: '/usr/sbin/sshd -D' },
            { pid: 1024, user: 'mysql', command: 'mysqld' },
            { pid: 1337, user: 'player', command: 'bash' }
        ];

        if (this.level >= 4) {
            baseProcesses.push(
                { pid: 1234, user: 'player', command: '/usr/bin/suspicious_process --flag=flag{process_hunter_success}' }
            );
        }

        return baseProcesses;
    }

    initializeNetwork() {
        const baseConnections = [
            { proto: 'tcp', local: '0.0.0.0:22', foreign: '0.0.0.0:*', state: 'LISTEN' },
            { proto: 'tcp6', local: ':::80', foreign: ':::*', state: 'LISTEN' }
        ];

        if (this.level >= 5) {
            baseConnections.push(
                { proto: 'tcp', local: '127.0.0.1:12345', foreign: '0.0.0.0:*', state: 'LISTEN' }
            );
        }

        return baseConnections;
    }

    initializeServices() {
        const baseServices = [
            { name: 'ssh', status: 'running', port: 22 },
            { name: 'nginx', status: 'running', port: 80 }
        ];

        if (this.level >= 7) {
            baseServices.push(
                { name: 'flag-service', status: 'running', port: 31337 }
            );
        }

        return baseServices;
    }

    initializeFileSystem() {
        const fs = {
            '/': {
                type: 'dir',
                permissions: 'drwxr-xr-x',
                owner: 'root',
                group: 'root',
                contents: {
                    'bin': {
                        type: 'dir',
                        permissions: 'drwxr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: {
                            'bash': { type: 'file', permissions: '-rwxr-xr-x', owner: 'root', group: 'root', content: 'ELF...' },
                            'ls': { type: 'file', permissions: '-rwxr-xr-x', owner: 'root', group: 'root', content: 'ELF...' }
                        }
                    },
                    'etc': {
                        type: 'dir',
                        permissions: 'drwxr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: {
                            'passwd': {
                                type: 'file',
                                permissions: '-rw-r--r--',
                                owner: 'root',
                                group: 'root',
                                content: 'root:x:0:0:root:/root:/bin/bash\nplayer:x:1000:1000:Player,,,:/home/player:/bin/bash'
                            },
                            'shadow': {
                                type: 'file',
                                permissions: '-rw-r-----',
                                owner: 'root',
                                group: 'shadow',
                                content: 'root:$6$xyz...\nplayer:$6$abc...'
                            },
                            'hostname': {
                                type: 'file',
                                permissions: '-rw-r--r--',
                                owner: 'root',
                                group: 'root',
                                content: 'quicksnatch'
                            }
                        }
                    },
                    'home': {
                        type: 'dir',
                        permissions: 'drwxr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: {
                            'player': this.initializeHomeDirectory()
                        }
                    },
                    'proc': {
                        type: 'dir',
                        permissions: 'dr-xr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: this.initializeProcDirectory()
                    },
                    'var': {
                        type: 'dir',
                        permissions: 'drwxr-xr-x',
                        owner: 'root',
                        group: 'root',
                        contents: {
                            'log': {
                                type: 'dir',
                                permissions: 'drwxr-xr-x',
                                owner: 'root',
                                group: 'root',
                                contents: {
                                    'auth.log': {
                                        type: 'file',
                                        permissions: '-rw-r--r--',
                                        owner: 'root',
                                        group: 'root',
                                        content: 'Jan 18 10:42:01 quicksnatch sshd[854]: Server listening on 0.0.0.0 port 22.'
                                    }
                                }
                            }
                        }
                    }
                }
            }
        };

        // Add level-specific files
        this.addLevelSpecificFiles(fs);
        return fs;
    }

    addLevelSpecificFiles(fs) {
        const playerHome = fs['/'].contents['home'].contents['player'];
        
        switch(this.level) {
            case 1:
                // Level 1: Hidden Files Challenge
                playerHome.contents['.secret'] = {
                    type: 'file',
                    permissions: '-rw-r--r--',
                    owner: 'player',
                    group: 'player',
                    content: 'flag{file_explorer_pro}'
                };
                break;

            case 2:
                // Level 2: Permissions Challenge
                playerHome.contents['restricted.txt'] = {
                    type: 'file',
                    permissions: '-r--------',
                    owner: 'root',
                    group: 'root',
                    content: 'flag{chmod_master}'
                };
                break;

            case 3:
                // Level 3: Log Analysis Challenge
                playerHome.contents['system.log'] = {
                    type: 'file',
                    permissions: '-rw-r--r--',
                    owner: 'player',
                    group: 'player',
                    content: `
2024-01-18 10:00:01 System startup
2024-01-18 10:00:02 User login: admin
2024-01-18 10:00:03 flag{grep_master_123}
2024-01-18 10:00:04 Service started: nginx
2024-01-18 10:00:05 Database connection established
                    `.trim()
                };
                break;

            case 4:
                // Level 4: Process Challenge
                this.processes.push({
                    pid: 31337,
                    user: 'root',
                    command: './suspicious_process flag{process_hunter}'
                });
                break;

            case 5:
                // Level 5: Network Challenge
                this.networkConnections.push({
                    proto: 'tcp',
                    local: '127.0.0.1:31337',
                    foreign: '*:*',
                    state: 'LISTEN',
                    info: 'flag{network_ninja}'
                });
                break;

            case 6:
                // Level 6: Environment Variables Challenge
                this.environment['SECRET_FLAG'] = 'flag{bash_wizard}';
                break;

            case 7:
                // Level 7: Service Challenge
                playerHome.contents['service.conf'] = {
                    type: 'file',
                    permissions: '-rw-r--r--',
                    owner: 'player',
                    group: 'player',
                    content: `
service_port=31337
service_token=flag{archive_master_explorer}
                    `.trim()
                };
                break;

            case 8:
                // Level 8: Process Monitor Challenge
                this.environment['MYSQL_PASSWORD'] = 'flag{system_monitor_pro}';
                playerHome.contents['db_backup.sql'] = {
                    type: 'file',
                    permissions: '-rw-r--r--',
                    owner: 'player',
                    group: 'player',
                    content: `
-- MySQL dump
CREATE TABLE users (
    id INT,
    username VARCHAR(50),
    password VARCHAR(50)
);
INSERT INTO users VALUES (1, 'admin', 'flag{system_monitor_pro}');
                    `.trim()
                };
                break;

            case 9:
                // Level 9: Cron Challenge
                playerHome.contents['crontab'] = {
                    type: 'file',
                    permissions: '-rw-r--r--',
                    owner: 'player',
                    group: 'player',
                    content: Buffer.from('flag{cr0n_master_detective}').toString('base64')
                };
                break;

            case 10:
                // Level 10: Ultimate Challenge
                playerHome.contents['.git'] = {
                    type: 'dir',
                    permissions: 'drwxr-xr-x',
                    owner: 'player',
                    group: 'player',
                    contents: {
                        'HEAD': {
                            type: 'file',
                            permissions: '-rw-r--r--',
                            owner: 'player',
                            group: 'player',
                            content: 'ref: refs/heads/master'
                        },
                        'config': {
                            type: 'file',
                            permissions: '-rw-r--r--',
                            owner: 'player',
                            group: 'player',
                            content: '[core]\n\trepositoryformatversion = 0\n\tfilemode = true\n\tbare = false'
                        }
                    }
                };
                break;
        }

        // Add level-specific welcome message and hints
        this.welcomeMessages = {
            1: [
                'Welcome to Level 1: Hidden Files Challenge',
                'Your task is to find a hidden flag in the file system.',
                'Hint: Not all files are visible by default. Try using ls with special flags.',
                'Commands you might need: ls, cd, cat'
            ],
            2: [
                'Welcome to Level 2: Permission Master Challenge',
                'There\'s a file with restricted permissions.',
                'Hint: Check file permissions and try to find ways to read it.',
                'Commands you might need: ls -l, chmod, cat'
            ],
            3: [
                'Welcome to Level 3: Log Analysis Challenge',
                'There\'s a flag hidden in the system logs.',
                'Hint: Use text processing commands to find the flag.',
                'Commands you might need: cat, grep, less'
            ],
            4: [
                'Welcome to Level 4: Process Hunter Challenge',
                'There\'s a suspicious process running with the flag.',
                'Hint: Look for unusual processes and their command lines.',
                'Commands you might need: ps, top, grep'
            ],
            5: [
                'Welcome to Level 5: Network Ninja Challenge',
                'A service is running with the flag.',
                'Hint: Check network connections and listening ports.',
                'Commands you might need: netstat, ss, grep'
            ],
            6: [
                'Welcome to Level 6: Environment Variable Challenge',
                'The flag is hidden in an environment variable.',
                'Hint: List and examine all environment variables.',
                'Commands you might need: env, printenv, echo'
            ],
            7: [
                'Welcome to Level 7: Service Authentication Challenge',
                'Find the service configuration with the flag.',
                'Hint: Look for configuration files and their contents.',
                'Commands you might need: ls, cat, grep'
            ],
            8: [
                'Welcome to Level 8: Database Challenge',
                'The flag is hidden in the database backup.',
                'Hint: Examine database files and credentials.',
                'Commands you might need: cat, grep, mysql'
            ],
            9: [
                'Welcome to Level 9: Encryption Challenge',
                'There\'s an encrypted file containing the flag.',
                'Hint: The file is base64 encoded.',
                'Commands you might need: cat, base64'
            ],
            10: [
                'Welcome to Level 10: Git Master Challenge',
                'The flag is hidden in the git repository.',
                'Hint: Examine the git history and configuration.',
                'Commands you might need: git log, git show, cat'
            ]
        };
    }

    initializeHomeDirectory() {
        return {
            type: 'dir',
            permissions: 'drwxr-xr-x',
            owner: 'player',
            group: 'player',
            contents: {
                'Documents': {
                    type: 'dir',
                    permissions: 'drwxr-xr-x',
                    owner: 'player',
                    group: 'player',
                    contents: {}
                },
                'Pictures': {
                    type: 'dir',
                    permissions: 'drwxr-xr-x',
                    owner: 'player',
                    group: 'player',
                    contents: {}
                },
                'Desktop': {
                    type: 'dir',
                    permissions: 'drwxr-xr-x',
                    owner: 'player',
                    group: 'player',
                    contents: {}
                }
            }
        };
    }

    initializeProcDirectory() {
        return {
            '1': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'root',
                group: 'root',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'root',
                        group: 'root',
                        content: '/sbin/init'
                    }
                }
            },
            '2': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'root',
                group: 'root',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'root',
                        group: 'root',
                        content: '[kthreadd]'
                    }
                }
            },
            '854': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'root',
                group: 'root',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'root',
                        group: 'root',
                        content: '/usr/sbin/sshd -D'
                    }
                }
            },
            '1024': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'mysql',
                group: 'mysql',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'mysql',
                        group: 'mysql',
                        content: 'mysqld'
                    }
                }
            },
            '1337': {
                type: 'dir',
                permissions: 'dr-xr-xr-x',
                owner: 'player',
                group: 'player',
                contents: {
                    'cmdline': {
                        type: 'file',
                        permissions: '-r--r--r--',
                        owner: 'player',
                        group: 'player',
                        content: 'bash'
                    }
                }
            }
        };
    }

    getCurrentDir() {
        let path = this.currentDirectory === '~' ? '/home/player' : this.currentDirectory;
        let parts = path.split('/').filter(p => p);
        let current = this.fileSystem['/'];
        
        for (const part of parts) {
            if (part === 'home' || part === 'player') {
                current = current.contents[part];
            } else {
                current = current.contents[part];
            }
            if (!current) return null;
        }
        
        return current;
    }

    catFile(filename) {
        if (!filename) {
            return 'cat: missing operand\nTry \'cat --help\' for more information.';
        }

        const currentDir = this.getCurrentDir();
        if (!currentDir) {
            return 'cat: cannot access current directory';
        }

        // Handle path with directories
        if (filename.includes('/')) {
            const parts = filename.split('/').filter(p => p);
            let current = currentDir;
            
            // Handle absolute paths
            if (filename.startsWith('/')) {
                current = this.fileSystem['/'];
            }
            
            // Navigate through the path
            for (let i = 0; i < parts.length - 1; i++) {
                const part = parts[i];
                if (part === '..') {
                    // TODO: Implement directory up navigation
                    continue;
                } else if (part === '.') {
                    continue;
                } else {
                    current = current.contents[part];
                }
                
                if (!current || current.type !== 'dir') {
                    return `cat: ${filename}: No such file or directory`;
                }
            }
            
            filename = parts[parts.length - 1];
            currentDir = current;
        }

        const file = currentDir.contents[filename];
        
        if (!file) {
            return `cat: ${filename}: No such file or directory`;
        }

        if (file.type === 'dir') {
            return `cat: ${filename}: Is a directory`;
        }

        // Check if user has read permission
        const isOwner = file.owner === this.username;
        const isInGroup = file.group === this.username;
        const permissions = file.permissions;
        
        const canRead = (
            (isOwner && permissions[1] === 'r') ||
            (isInGroup && permissions[4] === 'r') ||
            permissions[7] === 'r'
        );

        if (!canRead) {
            return `cat: ${filename}: Permission denied`;
        }

        return file.content;
    }

    changeDirectory(path) {
        if (!path || path === '~' || path === '/home/player') {
            this.currentDirectory = '~';
        } else if (path === '..') {
            if (this.currentDirectory !== '~') {
                this.currentDirectory = this.currentDirectory.split('/').slice(0, -1).join('/') || '~';
            }
        } else if (path === '/') {
            this.currentDirectory = '/';
        } else if (path.startsWith('/')) {
            // Handle absolute paths
            const parts = path.split('/').filter(p => p);
            let current = this.fileSystem['/'];
            
            for (const part of parts) {
                if (!current.contents[part] || current.contents[part].type !== 'dir') {
                    return `cd: ${path}: No such directory`;
                }
                current = current.contents[part];
            }
            this.currentDirectory = path;
        } else {
            // Handle relative paths
            const dir = this.getCurrentDir();
            if (dir && dir.contents[path] && dir.contents[path].type === 'dir') {
                this.currentDirectory = this.currentDirectory === '~' ? 
                    `~/${path}` : `${this.currentDirectory}/${path}`;
            } else {
                return `cd: ${path}: No such directory`;
            }
        }
        this.updatePrompt();
    }

    listDirectory(args) {
        const showHidden = args.includes('-a') || args.includes('-la') || args.includes('-al');
        const showDetails = args.includes('-l') || args.includes('-la') || args.includes('-al');
        
        const dir = this.getCurrentDir();
        if (!dir) return;

        const files = Object.entries(dir.contents)
            .filter(([name]) => showHidden || !name.startsWith('.'))
            .map(([name, info]) => {
                if (showDetails) {
                    const type = info.type === 'dir' ? 'd' : '-';
                    const perms = type === 'd' ? 'rwxr-xr-x' : 'rw-r--r--';
                    const size = info.type === 'dir' ? '-' : info.content.length;
                    return `${type}${perms} ${this.username} ${this.username} ${size} Jan 18 10:33 ${name}`;
                }
                return name;
            });

        return files.join('\n') || 'Directory is empty';
    }

    listProcesses() {
        const header = '  PID TTY          TIME CMD';
        const processes = this.processes
            .filter(p => p.user === this.username)
            .map(p => `${p.pid.toString().padStart(5)} pts/0    00:00:00 ${p.command}`);
        return [header, ...processes].join('\n');
    }

    listNetworkConnections() {
        const header = 'Proto Recv-Q Send-Q Local Address           Foreign Address         State';
        const connections = this.networkConnections.map(c =>
            `${c.proto}        0      0 ${c.local.padEnd(22)} ${c.foreign.padEnd(22)} ${c.state}`
        );
        return [header, ...connections].join('\n');
    }

    listEnvironment() {
        const output = Object.entries(this.environment)
            .map(([key, value]) => `${key}=${value}`)
            .join('\n');
        return output;
    }

    ps(args) {
        // Parse options
        const options = new Set(args.join('').split(''));
        const showAll = options.has('a') || options.has('e');
        const showUser = options.has('u');
        const showAxu = args.includes('aux') || args.includes('aux');
        
        if (args.includes('--help')) {
            return this.psHelp();
        }

        // Format processes based on options
        let processes = [...this.processes];
        
        // Filter processes based on options
        if (!showAll && !showAxu) {
            processes = processes.filter(p => p.user === this.username);
        }

        // Different output formats based on options
        if (showAxu || showUser) {
            // Full format (ps aux)
            const now = new Date();
            const header = 'USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND';
            const formatted = processes.map(p => {
                const user = p.user.padEnd(8);
                const pid = p.pid.toString().padStart(5);
                const cpu = '0.0';
                const mem = '0.1';
                const vsz = '5000';
                const rss = '1000';
                const tty = 'pts/0';
                const stat = 'S+';
                const start = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                const time = '0:00';
                const command = p.command;
                
                return `${user} ${pid} ${cpu} ${mem} ${vsz} ${rss} ${tty} ${stat} ${start} ${time} ${command}`;
            });
            
            return [header, ...formatted].join('\n');
        } else {
            // Simple format (ps)
            const header = '  PID TTY          TIME CMD';
            const formatted = processes.map(p => {
                const pid = p.pid.toString().padStart(5);
                const tty = 'pts/0    ';
                const time = '00:00:00';
                const command = p.command;
                
                return `${pid} ${tty} ${time} ${command}`;
            });
            
            return [header, ...formatted].join('\n');
        }
    }

    psHelp() {
        return `Usage:
 ps [options]

Basic options:
 -e, -A              all processes
 a                   all w/ tty, including other users
 -a                  all w/ tty, except session leaders
 -d                  all except session leaders
 -N, --deselect     negate selection
 r                   only running processes
 T                   all processes on this terminal
 x                   processes without controlling ttys

Selection by list:
 -C <command>        command name
 -G, --Group <GID>   real group id or name
 -g, --group <group> session or effective group name
 p, p, --pid <PID>   process id
 -s, --sid <session> session id
 -t, t, --tty <tty>  terminal
 -u, U, --user <UID> effective user id or name
 -U, --User <UID>    real user id or name

Output formats:
 -F                  extra full
 -f                  full-format, including command lines
 u                   user-oriented
 v                   virtual memory format
 X                   register format
 -y                  do not show flags, show rss vs. addr (used with -l)
 --context          display security context (for SELinux)
 -Z, --context      same as --context
 -H                  show process hierarchy (forest)

For more details see ps(1).`;
    }

    handleMySQLCommand(args) {
        if (this.level !== 8) return 'MySQL is not available at this level';
        if (args[0] === '-u' && args[1] === 'root') {
            return 'Access denied for user \'root\'@\'localhost\'';
        }
        return 'Welcome to MySQL monitor. Type \'help\' or \'\\h\' for help.';
    }

    handleBase64Decode(args) {
        if (this.level !== 9) return 'base64 command is not available at this level';
        if (!args.length) return 'base64: missing operand';
        try {
            return Buffer.from(args[0], 'base64').toString('utf8');
        } catch {
            return 'base64: invalid input';
        }
    }

    handleGitCommand(args) {
        if (this.level !== 10) return 'git command is not available at this level';
        const [subcmd, ...subargs] = args;
        switch(subcmd) {
            case 'log':
                return `commit abc123def456
Author: Admin <admin@quicksnatch>
Date: ${new Date().toISOString()}

    Added secret flag

commit def456abc123
Author: Admin <admin@quicksnatch>
Date: ${new Date().toISOString()}

    Initial commit`;
            case 'show':
                if (subargs[0] === 'abc123def456') {
                    return 'flag{git_master}';
                }
                return 'commit not found';
            default:
                return `git: '${subcmd}' is not a git command. See 'git --help'`;
        }
    }

    chmod(mode, target) {
        if (!mode || !target) {
            return 'chmod: missing operand\nTry \'chmod --help\' for more information.';
        }

        if (mode === '--help') {
            return this.chmodHelp();
        }

        const currentDir = this.getCurrentDir();
        if (!currentDir) {
            return 'chmod: cannot access current directory';
        }

        // Handle path with directories
        const parts = target.split('/').filter(p => p);
        let targetDir = currentDir;
        let targetName = target;

        // Handle absolute paths and navigation
        if (target.startsWith('/')) {
            targetDir = this.fileSystem['/'];
            targetName = parts[parts.length - 1];
            parts.pop(); // Remove filename from parts

            // Navigate to target directory
            for (const part of parts) {
                if (!targetDir.contents[part] || targetDir.contents[part].type !== 'dir') {
                    return `chmod: cannot access '${target}': No such file or directory`;
                }
                targetDir = targetDir.contents[part];
            }
        } else if (parts.length > 1) {
            targetName = parts[parts.length - 1];
            parts.pop(); // Remove filename from parts

            // Navigate to target directory
            for (const part of parts) {
                if (part === '..') {
                    // Go up one directory
                    const parentDir = this.getParentDir(targetDir);
                    if (!parentDir) {
                        return `chmod: cannot access '${target}': No such file or directory`;
                    }
                    targetDir = parentDir;
                } else if (part === '.') {
                    continue;
                } else {
                    if (!targetDir.contents[part] || targetDir.contents[part].type !== 'dir') {
                        return `chmod: cannot access '${target}': No such file or directory`;
                    }
                    targetDir = targetDir.contents[part];
                }
            }
        }

        const file = targetDir.contents[targetName];
        if (!file) {
            return `chmod: cannot access '${target}': No such file or directory`;
        }

        // Check if user has permission to change mode
        if (file.owner !== this.username && this.username !== 'root') {
            return `chmod: changing permissions of '${target}': Operation not permitted`;
        }

        try {
            let newMode = '';
            if (/^[0-7]{3}$/.test(mode)) {
                // Octal mode (e.g., 644)
                const type = file.type === 'dir' ? 'd' : '-';
                newMode = type + this.octalToSymbolic(mode);
            } else if (/^[ugoa]*[-+=][rwx]+$/.test(mode)) {
                // Symbolic mode (e.g., u+rw)
                newMode = this.updateSymbolicMode(file.permissions, mode);
            } else {
                return `chmod: invalid mode: '${mode}'`;
            }

            file.permissions = newMode;
            return '';
        } catch (error) {
            return `chmod: invalid mode: '${mode}'`;
        }
    }

    octalToSymbolic(octal) {
        const mapping = {
            0: '---',
            1: '--x',
            2: '-w-',
            3: '-wx',
            4: 'r--',
            5: 'r-x',
            6: 'rw-',
            7: 'rwx'
        };
        
        return mapping[octal[0]] + mapping[octal[1]] + mapping[octal[2]];
    }

    updateSymbolicMode(currentMode, change) {
        // Keep the file type character
        const type = currentMode[0];
        const perms = currentMode.slice(1);
        
        // Parse the symbolic mode
        const match = change.match(/^([ugoa]*)([+-=])([rwx]+)$/);
        if (!match) {
            throw new Error('Invalid mode format');
        }

        const [, who, op, permissions] = match;
        const targets = who || 'a';

        // Define permission positions
        const positions = {
            u: [0, 1, 2],    // user
            g: [3, 4, 5],    // group
            o: [6, 7, 8],    // others
            a: [0, 1, 2, 3, 4, 5, 6, 7, 8]  // all
        };

        // Get affected positions
        const affectedPos = targets.split('').reduce((acc, t) => {
            return acc.concat(positions[t]);
        }, []);

        // Create new permission string
        let newPerms = perms.split('');
        
        for (const pos of new Set(affectedPos)) {
            const permType = pos % 3; // 0=r, 1=w, 2=x
            const perm = ['r', 'w', 'x'][permType];
            
            if (op === '=') {
                newPerms[pos] = permissions.includes(perm) ? perm : '-';
            } else if (op === '+' && permissions.includes(perm)) {
                newPerms[pos] = perm;
            } else if (op === '-' && permissions.includes(perm)) {
                newPerms[pos] = '-';
            }
        }

        return type + newPerms.join('');
    }

    chmodHelp() {
        return `Usage: chmod [OPTION]... MODE[,MODE]... FILE...
  or:  chmod [OPTION]... OCTAL-MODE FILE...
  or:  chmod [OPTION]... --reference=RFILE FILE...
Change the mode of each FILE to MODE.

Modes can be specified as:
  Octal:      chmod 644 file
  Symbolic:   chmod u+x file

Each MODE is of the form '[ugoa][-+=][rwx]':
  [ugoa]  - affects user/group/other/all
  [-+=]   - remove/add/set permissions
  [rwx]   - read/write/execute

Examples:
  chmod 644 file        - Set permissions to rw-r--r--
  chmod u+x file       - Add execute permission for owner
  chmod g-w file       - Remove write permission from group
  chmod a=rx file      - Set rx permissions for all
  chmod u+w,g+w file   - Add write permission for owner and group

Report bugs to: support@quicksnatch.com`;
    }
}

// Initialize terminal when document is ready
document.addEventListener('DOMContentLoaded', () => {
    window.terminal = new Terminal();
    terminal.init();
});
</script>
{% endblock %}
